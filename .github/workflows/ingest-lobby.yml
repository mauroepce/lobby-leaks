name: Scheduled Lobby Ingestion

on:
  schedule:
    # Run daily at 7:00 AM UTC (4:00 AM Chile, 3:00 AM Chile DST)
    - cron: '0 7 * * *'
  workflow_dispatch:
    # Allow manual trigger for testing
    inputs:
      days:
        description: 'Days to look back (default: 7)'
        required: false
        default: '7'
        type: string

jobs:
  ingest:
    name: Ingest Lobby Data
    runs-on: ubuntu-latest

    services:
      db:
        image: postgres:16
        env:
          POSTGRES_USER: lobbyleaks
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: lobbyleaks
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U lobbyleaks"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DATABASE_URL: postgresql://lobbyleaks:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/lobbyleaks
      DIRECT_URL: postgresql://lobbyleaks:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/lobbyleaks
      ENABLE_LOBBY_API: ${{ secrets.ENABLE_LOBBY_API || 'false' }}
      LOBBY_API_KEY: ${{ secrets.LOBBY_API_KEY || '' }}
      LOBBY_API_BASE_URL: ${{ vars.LOBBY_API_BASE_URL || 'https://www.leylobby.gob.cl/api/v1' }}
      INGEST_DAYS: ${{ github.event.inputs.days || '7' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip setuptools
          python3 -m pip install -r requirements.txt
          python3 -m pip install -r services/lobby_collector/requirements.txt

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres
        run: |
          until pg_isready -h localhost -p 5432 -U lobbyleaks; do
            echo "Waiting for Postgres..."
            sleep 1
          done

      - name: Apply migrations
        run: npx prisma@6.12.0 migrate deploy --schema=prisma/schema.prisma

      - name: Run Lobby Ingestion
        id: ingest
        run: |
          # Run ingestion and capture output
          # Always exits 0 (safe fallback) - metrics indicate actual status
          make ingest-lobby DAYS=${{ env.INGEST_DAYS }}

      - name: Upload metrics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ingest-metrics-${{ github.run_id }}
          path: ingest-metrics.json
          retention-days: 30
          if-no-files-found: ignore
